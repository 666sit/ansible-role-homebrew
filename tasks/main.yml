---
- name: Ensure homebrew is installed.
  git:
    repo: git://github.com/Homebrew/homebrew.git
    version: master
    dest: "{{ homebrew_install_path }}"
    update: no
    accept_hostkey: yes
  sudo: no

- name: Check if homebrew binary is already in place.
  stat: path=/usr/local/bin/brew
  register: homebrew_binary

- name: Symlink brew to /usr/local/bin/brew.
  file:
    src: "{{ homebrew_install_path }}/bin/brew"
    dest: /usr/local/bin/brew
    state: link
  when: homebrew_binary.stat.exists == false

- name: Get list of installed homebrew packages.
  command: brew list
  register: homebrew_list
  always_run: yes
  changed_when: false

- name: Install configured homebrew packages.
  command: "brew install {{ item }}"
  with_items: homebrew_installed_packages
  register: brew_install
  changed_when: "'already installed' not in brew_install.stderr"
  when: "'{{ item }}' not in homebrew_list.stdout"

- include: tap.yml

- include: cask.yml
  when: "'caskroom/cask' in homebrew_taps"
